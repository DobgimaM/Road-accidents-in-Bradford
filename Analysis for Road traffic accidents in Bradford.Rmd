---
title: 'Bradford road traffic accidents'
author: "Dobgima Mofor"
#date: "2023-11-29"
output:
  pdf_document:
    toc: yes
  html_document:
    number_sections: yes
    self_contained: yes
    toc: yes
    toc_float: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r, results='hide', message=FALSE, warning=FALSE, echo=FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

library(tidyverse)
library(flextable)
library(forcats)

options(shiny.usecairo=T)
setalloccol = data.table::setalloccol
```

## Road traffic accidents in Bradford

**Task** The Director of Neighbourhoods wants to understand more about
road traffic crashes in Bradford. You, the HDRC data scientist, have
been asked to give some insight into road traffic crashes in Bradford.

*Note* Availability of more specific dates rather than years would allow
for calculation of rates

Datasets

```{r}
list.files()
```

```{r}
casualties <- read_csv("bfd_casualties.csv", show_col_types = FALSE)
crashes <- read.csv("bfd_crashes.csv")
vehicles <- read.csv("bfd_vehicles.csv")

attach(casualties)
```

#1. Descriptives

## Casualty severity
Majority of casualty cases were

```{r}
t1 <- table(casualty_severity)
t1
```

```{r}
ggplot(data = casualties,
       aes(x = casualty_severity), y = no_acc) +
  geom_bar(fill = '#44846fff') +
  facet_wrap(vars(accident_year)) +
  labs(title = 'Number of accident casualties against severity',
       subtitle = 'Stratified by year of accident',
       x = 'Casualty severity',
       y = 'Number of accidents') +
  theme_bw()

```
Overall, casualties have declined across all severity categories from 2018 to 2020

```{r}
df_sev <- table(casualties$casualty_severity,casualties$accident_year)
df_sev
```

```{r}
df <- data.frame(cbind(df_sev[,1],df_sev[,2],df_sev[,3]))
names(df) <- c('2018','2019',"2020")
df <- df %>% mutate(`2018` = ((`2020` - `2018`)/`2020`)*100) %>% 
  mutate(`2018` = round(`2018`,1)) %>% 
  mutate(`2019` = ((`2020` - `2019`)/`2020`)*100) %>% 
  mutate(`2019` = round(`2019`,1))

df_severity <- df %>% select('2020','% change from 2018'= '2018', '% change from 2019'='2019')

df_severity

```

## Casualty class

Drivers were twice as likely to be responsible for accidents as Pedestrians

```{r}
ggplot(data = casualties,
       aes(x = fct_infreq(casualty_class)), y = no_acc) +
  geom_bar(fill = '#44846fff') +
  facet_wrap(vars(sex_of_casualty)) +
  labs(title = 'Number of accident casualties against Casualty class',
       subtitle = 'Stratified by year of accident',
       x = 'Casualty class',
       y = 'Number of accidents') +
  theme_bw() 

```
## Casualties by road user type

```{r}
temp <- casualties %>%
  mutate(tag = ifelse(age_band_of_casualty %in% 'Data missing or out of range',1,0)) %>%
  slice(-(which(tag == 1))) %>% 
  select(-tag) %>% 
  group_by(casualty_type) %>% 
  mutate(cas_seq = row_number()) %>%
  mutate(tot_cas = max(cas_seq)) %>% 
  ungroup() %>% 
  arrange(casualty_type) %>% 
  mutate(tag = 0) %>% 
  mutate(tag = ifelse(tot_cas >= 200, 1,tag)) %>% 
#  mutate(tag = ifelse(tag == 0 & tot_cas >= 20,2,tag)) %>% 
#  mutate(tag = ifelse(tag == 0 & tot_cas< 20,3,tag)) %>%
  mutate(accident_year = factor(accident_year))

temp1 <- temp %>% 
  filter(cas_seq == 1) %>% 
  arrange(desc(tot_cas)) %>% 
  select(casualty_type, casualty_count = tot_cas) %>% 
  rename(`Casualty type` = "casualty_type", `Casualty count` = "casualty_count")

flextable(temp1, cwidth = 2, col_keys = names(temp1))
```

```{r}
df_typ <- table(casualties$casualty_type,casualties$accident_year)
```

Table 4: Reported road fatalities by road user type in Great Britain,
2021, compared with 2020, 2019 and 2011

```{r}
df1 <- data.frame(cbind(df_typ[,1],df_typ[,2],df_typ[,3]))
names(df1) <- c('2018','2019',"2020")
df1 <- df1 %>% mutate(`2018` = ((`2020` - `2018`)/`2020`)*100) %>% 
  mutate(`2018` = round(`2018`,1)) %>% 
  mutate(`2019` = ((`2020` - `2019`)/`2020`)*100) %>% 
  mutate(`2019` = round(`2019`, 1))

df_type <- df1 %>% cbind(rownames(df1)) %>% 
  select('Class'='rownames(df1)' ,'2020','% change from 2018'= '2018', '% change from 2019'='2019') %>% 
  arrange(desc(`2020`))

flextable(df_type, cwidth = 2)

```

### 200+ Casualties

```{r}

#temp$sex_of_casualty <- temp$sex_of_casualty %>% factor(levels = c('Male','Female'))

#casualty_type <- factor(casualty_type)

my_colors <- c("#006853ff", "#ff7733ff", '#001a70ff')  
names(my_colors) <- levels(factor(levels(temp$accident_year)))
my_scale <- scale_fill_manual(name = "Group", values = my_colors) 


ggplot(data = temp %>% 
         filter(tag == 1),
       aes(x = fct_infreq(casualty_imd_decile), fill = fct_infreq(accident_year))) +
    facet_wrap(vars(sex_of_casualty)) +
  geom_bar(position="dodge") +
  labs(title = 'Reported road fatalities by road user type in Bradford, 2020 compared with 2018',
         subtitle = '200+ total casualties',
      x = 'Casualty type',
      y = 'Number of accidents'
  ) +
  theme_classic() +
  theme(axis.text = element_text(size = 10, angle = 90, vjust = 0.5, hjust=0.5),
        axis.text.x = element_text(margin = margin(t = 0, unit = "cm"))) +
  my_scale
```

# Road user type

```{r}
df_age_m <- casualties %>% filter(sex_of_casualty == 'Male') %>% select(age_band_of_casualty,accident_year) %>% table()
df_age_f <- casualties %>% filter(sex_of_casualty == 'Female') %>% select(age_band_of_casualty,accident_year) %>% table()
```

Table 4: Reported road fatalities by road user type in Great Britain,
2021, compared with 2020, 2019 and 2011

```{r}
df2m <- data.frame(cbind(df_age_m[,1],df_age_m[,2], df_age_m[,3])) %>% mutate(Sex = 'Male')
df2f <- data.frame(cbind(df_age_f[,1],df_age_f[,2], df_age_f[,3])) %>% mutate(Sex = 'Female')
df2 <- rbind(df2m, df2f)
names(df2) <- c('2018','2019','2020', 'Sex')
df2 <- df2 %>% mutate(`2018` = ((`2020` - `2018`)/`2020`)*100) %>% 
  mutate(`2018` = round(`2018`,1)) %>% 
  mutate(`2019` = ((`2020` - `2019`)/`2020`)*100) %>% 
  mutate(`2019` = round(`2019`, 1))

df_sex <- df2 %>% 
  select('Sex','2020','% change from 2018'= '2018', '% change from 2019'='2019') %>% 
  arrange(desc(Sex))

Age <- c("0 - 5", "11 - 15", "16 - 20", "21 - 25", "26 - 35", "36 - 45", "46 - 55", "56 - 65", "6 - 10", "66 - 75", "Data missing or out of range", "Over 75", "0 - 5", "11 - 15", "16 - 20", "21 - 25", "26 - 35", "36 - 45", "46 - 55", "56 - 65", "6 - 10", "66 - 75", "Data missing or out of range", "Over 75")


df_sex1 <- factor(Age)  %>%
  cbind(df_sex) %>%
  group_by(Sex) %>% 
  arrange(Age) %>%
  ungroup()%>%
  arrange(desc(Sex)) %>%data.frame()

df_sexa <- df_sex1 %>% 
  slice(-11,-23) %>%
  group_by(Sex) %>% 
  mutate(ind = row_number()) %>% 
  ungroup() %>% 
  mutate(tag = 2)

# Re-order the rows

for (i in 2:nrow(df_sexa)) {
  if(df_sexa$ind[i] > 1 & df_sexa$ind[i] != 9)
    {
    df_sexa$tag[i] <- df_sexa$ind[i] + 1
  }
}

df_sexa$tag[df_sexa$ind == 1] <- 1

df_sexa <- df_sexa %>% 
                arrange(desc(Sex), tag) %>% 
                select(-ind, -tag) %>% 
                data_frame()

df_sexa <- df_sexa %>%
  data.frame() %>% 
  as_grouped_data(groups = "Sex")

names(df_sexa) <- c('Age cat','Sex', '2020', '% change from 2018', '% change from 2019')

df_sex <- flextable(df_sexa, names(df_sexa), cwidth = 1)
df_sex
```
```{r}

temp$sex_of_casualty <- temp$sex_of_casualty %>% factor(levels = c('Male','Female'))
temp$age_band_of_casualty <- temp$age_band_of_casualty %>% factor()


#(levels = c( '0 - 5', '11 - 15', '16 - 20', '21 - 25', '26 - 35', '36 - 45', '46 - 55',  #'56 - 65', '6 - 10', '66 - 75', 'Over 75 '))



my_colors <- c("#006853ff", "#ff7733ff")  
names(my_colors) <- levels(factor(levels(temp$sex_of_casualty)))
my_scale <- scale_fill_manual(name = "Group", values = my_colors) 
ggplot(data = temp %>% 
         filter(tag == 1),
       aes(x = fct_infreq(age_band_of_casualty))) +
  geom_bar(position="dodge", fill = '#001a70ff') +
  facet_wrap(vars(accident_year)) +
  labs(title = 'Reported road fatalities by road user type in Bradford, 2020 compared with 2018',
         subtitle = 'Casualties stratified by year of fatality and sex of casualty',
      x = 'Casualty type',
      y = 'Number of accidents'
  ) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  my_scale

ggplot(data = temp %>% 
         filter(tag == 1),
       aes(x = fct_infreq(age_band_of_casualty), fill = sex_of_casualty)) +
  geom_bar(position="dodge") +
  facet_wrap(vars(sex_of_casualty)) +
  labs(title = 'Reported road fatalities by road user type in Bradford, 2020 compared with 2018',
         subtitle = 'Casualties stratified by year of fatality and sex of casualty',
      x = 'Casualty type',
      y = 'Number of accidents'
  ) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  my_scale

```

## 3. Casualties and by age and sex


```{r}
#ggsave(path = here("study1", "figs", "bar_admissions_gender_dept.png"), 
#	p, width = 7, height = 7)
```
